<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="google-site-verification" content="google1353837d2ec77422.html"><title>thematic工具的重构 | Kaely</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script async src="https://www.googletagmanager.com/gtag/js?id=G-5HJZ375VHJ"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-5HJZ375VHJ');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 6.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">thematic工具的重构</h1><a id="logo" href="/.">Kaely</a><p class="description">迷陣</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">thematic工具的重构</h1><div class="post-meta">2022-02-17<span> | </span><span class="category"><a href="/categories/%E5%8F%AF%E8%A7%86%E5%8C%96/">可视化</a></span></div><a class="disqus-comment-count" href="/2022/02/17/tool-thematic-refactor/#vcomment"><span class="waline-comment-count" id="/2022/02/17/tool-thematic-refactor/"></span><span> 条评论</span></a><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%A1%E5%9D%97%E9%87%8D%E6%9E%84"><span class="toc-text">模块重构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E9%9B%86"><span class="toc-text">1.数据集</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E5%AF%BC%E5%85%A5"><span class="toc-text">数据集导入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%9B%86%E5%BB%BA%E6%A8%A1"><span class="toc-text">数据集建模</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%B8%B2%E6%9F%93%E5%BC%95%E6%93%8E"><span class="toc-text">2.渲染引擎</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%B1%82"><span class="toc-text">数据层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%B1%82"><span class="toc-text">计算层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8B%E4%BB%B6%E5%B1%82"><span class="toc-text">事件层</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%BE%91%E5%B1%82"><span class="toc-text">编辑层</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.数据模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="toc-text">4.可视化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E4%BD%93%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-text">总体架构设计</span></a></li></ol></div></div><div class="post-content"><p>前面说的thematic出图流程有一个明显<strong>诟病</strong>，从软件开发的角度上看相当的不成熟，就是一个纯业务流程的产物，前后端耦合极高，再加上很多很多业务化服务希望能自动集成出图的结果，所以一直有重构的想法，并让其更加易用、易扩展。之后幸运的看到了这么一篇文章<a target="_blank" rel="noopener" href="https://github.com/ascoders/weekly/blob/v2/121.%E7%B2%BE%E8%AF%BB%E3%80%8A%E5%89%8D%E7%AB%AF%E4%B8%8E%20BI%E3%80%8B.md">精读《前端与 BI》</a>，让我对整个流程有了新的想法。</p>
<span id="more"></span>

<h1 id="模块重构"><a href="#模块重构" class="headerlink" title="模块重构"></a>模块重构</h1><blockquote>
<p>BI 1.0 阶段的核心概念包括 <strong>数据集、渲染引擎、数据模型、可视化</strong> 这四个技术模块。</p>
</blockquote>
<p>通过这四个模块来重新解构我的需求：</p>
<h2 id="1-数据集"><a href="#1-数据集" class="headerlink" title="1.数据集"></a>1.数据集</h2><p>BI的概念中为封装好的某一类数据，用于做后续的分析，出图整个场景就是在对数据不断的进行定制化结构改造，可以当作数据集来维护的有以下几个部分：</p>
<ol>
<li>观测类的站点数据，存放在数据库中，通过文本字符进行传输；</li>
<li>预报类的格点数据，存放在nc文件中，通过文本字符进行传输；</li>
<li>地理信息静态数据，可以是省市县的边界信息、特定的流域、区域，通常是geojson格式的文件。</li>
</ol>
<h3 id="数据集导入"><a href="#数据集导入" class="headerlink" title="数据集导入"></a>数据集导入</h3><p>对于上述1、2两类数据集，理论上由独立的数据服务提供交互，不涉及导入，对于第3类数据集，可以提供相应模板，支持用户根据模板自主上传地理信息数据。</p>
<h3 id="数据集建模"><a href="#数据集建模" class="headerlink" title="数据集建模"></a>数据集建模</h3><p>重点需要对上述各类型数据集的字段配置进行建模，确保在计算场景的交互上不会出现异常和报错。</p>
<h2 id="2-渲染引擎"><a href="#2-渲染引擎" class="headerlink" title="2.渲染引擎"></a>2.渲染引擎</h2><p>我将引擎理解为整个系统的驱动力和中枢神经。为了串联好各个环节的功能和数据，需要提前定义好以下几个重要的模块，来确保渲染的过程不会有任何的问题。</p>
<h3 id="数据层"><a href="#数据层" class="headerlink" title="数据层"></a>数据层</h3><p>主要用来对接所有的数据服务，或是对某个在线数据进行解析处理。整体而言是轻量的，有点adapter的意思，获取不同源头的数据并进行标准化的质控和预处理。</p>
<h3 id="计算层"><a href="#计算层" class="headerlink" title="计算层"></a>计算层</h3><p>主要用来对数据进行二次加工，或者对数据进行指定格式的转化。是原始数据到可绘制数据的中间桥梁，当然不是所有数据都要通过计算引擎。</p>
<h3 id="事件层"><a href="#事件层" class="headerlink" title="事件层"></a>事件层</h3><p>考虑业务流程中的各种操作频繁，也为了契合js事件驱动的想法，需要统一的事件中心来触发和相应各个流程节点和操作节点。</p>
<h3 id="编辑层"><a href="#编辑层" class="headerlink" title="编辑层"></a>编辑层</h3><p>该模块会依然沿用fabric.js的方案，来对所有绘制完的结果进行后期的组装、微调和输出。</p>
<h2 id="3-数据模型"><a href="#3-数据模型" class="headerlink" title="3.数据模型"></a>3.数据模型</h2><p>新thematic的数据模型应当包含业务逻辑和数据流程两条主线。业务逻辑即针对编辑引擎的位置坐标模型、针对图形最终结果的图层参数模型；数据流程即针对不同数据集的字段指标模型、针对不同计算结果的中间参数模型。这里没法穷举所有的结论，总体而言应该对不同标准的数据都需要对应的展现。</p>
<h2 id="4-可视化"><a href="#4-可视化" class="headerlink" title="4.可视化"></a>4.可视化</h2><p>正如文章中所说，<strong>大数据性能优化、边界数据展示优化、交互响应</strong>是BI可视化组件的与传统组件的几个显著区分点。这几个问题也是我们气象行业对数据进行展示遇到的老大难问题。<br>庆幸的是技术总是在日新月异的发展，我们所面临的挑战则是开发一套横向扩展性较高的系统，这样在对不同数据进行可视化呈现时，可以考量数据格式和开发语言不断从上述3个方向找寻最合适的方案。</p>
<h1 id="总体架构设计"><a href="#总体架构设计" class="headerlink" title="总体架构设计"></a>总体架构设计</h1><p>我希望重构完的thematic能实现如下几个重要的目标：</p>
<ul>
<li>区分admin和user的职责</li>
<li>admin负责配置出图的模板和任务，user通过接口来单向的获取图片结果</li>
<li>既然有了模板和任务，那意味着各种类型的图层参数都是完全可配的</li>
<li>有可能的话，为了追求性能，将渲染的过程以server端的形式来实现</li>
</ul>
<p>基于上面的目标，新的thematic会拆解成如下几个模块，具体的关系如下图所示意：</p>
<ul>
<li><strong>可视化平台</strong>：用于管理员配置各种类型图片的默认出图参数</li>
<li><strong>服务层</strong>：用于出图参数的增删改查</li>
<li><strong>渲染层</strong>：根据参数请求数据，并将数据渲染成图片</li>
</ul>
<p><img src="https://blog-img-1255388623.cos.ap-shanghai.myqcloud.com/chart-studio-design-20220209174839.jpg" alt="chart-studio-design"></p>
<p>PS：希望这是公司内第一个<code>no code</code>或者是<code>low code</code>平台。</p>
<p>参考文档：<br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzU4MzUzODc3Nw==&mid=2247484815&idx=1&sn=ccc3ea2e8d3799e9fd616e2a7a386d75&chksm=fda6c4b9cad14dafb26f02c10598dab11a6333f8a5890ae90f839a0e42cc9a9bc5a903af20e7&mpshare=1&scene=1&srcid=0109hTLZ16lbquz8Bd4ikilp&sharer_sharetime=1641738189459&sharer_shareid=4755c0bae34e62c2cd22339c28558953#rd">动态图片生成方案</a><br><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=Mzg4MTYwMzY1Mw==&mid=2247498945&idx=1&sn=097b7c83c85f5f9fc5049ac7f009c108&chksm=cf61d9ebf81650fd27165b47a2b9b3bd863e91f75a6718fdbb2f6599855b6a89f544cb820b93&mpshare=1&scene=1&srcid=0115J8sWxXlw49K1YDVffSx3&sharer_sharetime=1642259798984&sharer_shareid=4755c0bae34e62c2cd22339c28558953#rd">如何设计实现H5营销页面搭建系统</a></p>
</div><div class="tags"></div><div class="post-nav"><a class="next" href="/2022/02/12/tool-thematic-intro/">thematic工具的诞生</a></div><div id="waline"></div><script src="https://cdn.jsdelivr.net/npm/@waline/client"></script><script>Waline({
  el: '#waline',
  serverURL: 'https://waline-server.vercel.app/',
  pageSize: '',
})
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://kaely.net"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cesium/">Cesium</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PostGIS/">PostGIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/TileStrata/">TileStrata</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/WebGIS/">WebGIS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%8F%AF%E8%A7%86%E5%8C%96/">可视化</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://github.com/zzcyrus" title="我的Github" target="_blank">我的Github</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">Kaely.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js?v=1.0.0"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins')) || {};
  mermaid.initialize(options);
}</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>